# name: test/sql/test_simplify.test
# description: ST_SIMPLIFY test
# group: [sql]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

#test with POINT
query I
SELECT ST_ASTEXT(ST_SIMPLIFY('POINT(30 10.2323)', 1))
----
POINT(30 10.2323)

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('010100000000000000000024400000000000004B40', 2))
----
POINT(10 54)

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('{"type":"Point","coordinates":[-71.064544,10.2323]}', 3))
----
POINT(-71.064544 10.2323)

#test with LINESTRING
query I
SELECT ST_ASTEXT(ST_SIMPLIFY('LINESTRING(0 0, 0 10, 0 51, 50 20, 30 20, 7 32)', 2))
----
LINESTRING(0 0,0 51,50 20,30 20,7 32)

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('010200000003000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d36531214540', 50))
----
LINESTRING(-71.160281 42.258729,-71.161144 42.25932)

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('{"type":"LineString","coordinates":[[1,1],[2,2],[2,3],[4,4]]}', 2))
----
LINESTRING(1 1,4 4)

#test with POLYGON
query I
SELECT ST_ASTEXT(ST_SIMPLIFY('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))', 0.001))
----
POLYGON((-71.17166 42.353675,-71.171794 42.354971,-71.170511 42.354855,-71.17166 42.353675))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('010300000001000000210000009f9eb2d41bf360400000000000002e4032d435e64fcc60402fb55b00da8505406ea475c8695960400000000000000000aa5d4db3a73d5f40fd1cf7917cfc534044f2fd6f73475d40ca0d02908c9851400ae3086e83e35a4081446599b0444f40e88b46e15b295840496e29de585a4c404f22fd2fd133554039af2867c08e4a400700000000205240a08535ad90f349407dbb05a05d184e402aaf2867c08e4a404de8723d482d48403b6e29de585a4c40073aee23f9b8424073446599b0444f402837084032e23b40bc0d02908c9851401e89ca3261093440ef1cf7917cfc534024b9a57863692c400000000000000000e2bca29c013b25402fb55b00da8505407916d6b442ce22400000000000002e40aabca29c013b25405a89f4bf444f3b40ebb8a57863692c407b178dc2b7924340ca88ca326109344015c611dc06074940f036084032e23b4088e4fbdfe6ce4d40cf39ee23f9b84240aa5d4db3a7dd504014e8723d482d4840dc48eb90d352524053bb05a05d184e4064a86bcc9f385340f2ffffffff1f52403e3d65a9378653403a22fd2fd133554064a86bcc9f385340d38b46e15b295840dc48eb90d35252400ae3086e83e35a40aa5d4db3a7dd504044f2fd6f73475d4088e4fbdfe6ce4d40aa5d4db3a73d5f4015c611dc060749406ea475c86959604008188dc2b792434032d435e64fcc60405a89f4bf444f3b409f9eb2d41bf360400000000000002e40', 3))
----
POLYGON((135.59714732062 15,130.79416296937 0,124.963360620072 79.9451031602111,107.554896839789 62.5366393799277,72.5000000000001 51.9028526793802,48.3537670908996 56.7058370306299,20.0366393799278 79.9451031602109,14.20583703063 0,10.615246672502 2.690357210921,10.6152466725019 27.309642789079,20.0366393799275 50.054896839789,37.4451031602108 67.463360620072,60.190357210921 76.884753327498,84.8096427890786 76.884753327498,117.116420743937 59.616420743937,130.79416296937 39.146232909101,135.59714732062 15))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('{"type":"Polygon","coordinates":[[[0,0],[0,10],[150,10],[150,0],[0,0]],[[20,20],[50,20],[50,50],[20,50],[20,20]]]}', 50))
----
(empty)

#test with MULTIPOINT
query I
SELECT ST_ASTEXT(ST_SIMPLIFY('MULTIPOINT(0 0 3 2, 0 10 6 1, 0 51 1 6, 50 20 6 7, 30 20 9 9, 7 32 10 5)', 20))
----
MULTIPOINT ZM (0 0 3 2,0 10 6 1,0 51 1 6,50 20 6 7,30 20 9 9,7 32 10 5)

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('0104000000060000000101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f', 1))
----
MULTIPOINT(0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9)

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('{"type":"MultiPoint","coordinates":[[35,14]]}', 1))
----
MULTIPOINT(35 14)

#test with MULTILINESTRING
query I
SELECT ST_ASTEXT(ST_SIMPLIFY('MULTILINESTRING((0 0 3 2, 0 10 6 1, 0 51 1 6, 50 20 6 7, 30 20 9 9, 7 32 10 5), (0 0 4 3, 1 1 2 3, 20 20 5 30))', 20))
----
MULTILINESTRING ZM ((0 0 3 2,0 51 1 6,50 20 6 7,7 32 10 5),(0 0 4 3,20 20 5 30))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('01050000C00200000001020000C004000000000000000000000000000000000000000000000000000000000000000000F03F00000000000000000000000000001440000000000000000000000000000000400000000000001440000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000104001020000C004000000000000000000F03F000000000000F03F0000000000000000000000000000F03F0000000000000840000000000000F03F0000000000000000000000000000F03F000000000000F03F00000000000008400000000000000000000000000000F03F000000000000F03F000000000000F03F0000000000000000000000000000F03F', 2))
----
MULTILINESTRING ZM ((0 0 0 1,0 5 0 2,5 0 0 3,0 0 0 4))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('{"type":"MultiLineString","coordinates":[[[-89.734634999999997,31.492072000000000],[-89.734955999999997,31.492237999999997]]]}', 2))
----
MULTILINESTRING((-89.734635 31.492072,-89.734956 31.492237999999997))

#test with MULTIPOLYGON
query I
SELECT ST_ASTEXT(ST_SIMPLIFY('MULTIPOLYGON(((10 10, 10 13, 13 13, 13 10, 10 10)), ((0 0, 1 0, 1 1, 0 1, 0 0),(0.5 0.5, 0.5 0.6, 0.6 0.6, 0.8 0.5, 0.5 0.5)) )', 2))
----
MULTIPOLYGON(((10 10,10 13,13 13,13 10,10 10)))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('0106000000030000000103000000020000000500000000000000000010400000000000000000000000000000000000000000000010C000000000000010C00000000000000000000000000000000000000000000010400000000000001040000000000000000005000000000000000000004000000000000000000000000000000000000000000000004000000000000000C00000000000000000000000000000000000000000000000C0000000000000004000000000000000000103000000020000000500000000000000000038400000000000000000000000000000344000000000000010C000000000000030400000000000000000000000000000344000000000000010400000000000003840000000000000000005000000000000000000364000000000000000000000000000003440000000000000004000000000000032400000000000000000000000000000344000000000000000C0000000000000364000000000000000000103000000020000000500000000000000000046400000000000000000000000000000444000000000000010C000000000000042400000000000000000000000000000444000000000000010400000000000004640000000000000000005000000000000000000454000000000000000000000000000004440000000000000004000000000000043400000000000000000000000000000444000000000000000C000000000000045400000000000000000', 2))
----
MULTIPOLYGON(((4 0,0 -4,-4 0,0 4,4 0)),((24 0,20 -4,16 0,20 4,24 0)),((44 0,40 -4,36 0,40 4,44 0)))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}', 0.5))
----
MULTIPOLYGON(((-117 32,-117 33,-117 32,-116 32,-117 32)))

#test with COLLECTION
query I
SELECT ST_ASTEXT(ST_SIMPLIFY('GEOMETRYCOLLECTION(POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678)),LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932))', 1))
----
GEOMETRYCOLLECTION(LINESTRING(-71.160281 42.258729,-71.161144 42.25932))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('010700000004000000010300000001000000060000000000000000805bc0a6aaaaaaaaaa45400000000000805bc00000000000805140000000000020594000000000008051404016b29085ac4d4003f5a637bd694040e6a28b2eba68424000000000008056400000000000805bc0a6aaaaaaaaaa45400103000000010000000500000000000000004060400000000000c047400000000000406040c36ddbb66ddb46c0e6a28b2eba68424000000000008056404016b29085ac4d4003f5a637bd69404000000000004060400000000000c04740010300000001000000060000000000000000406040c36ddbb66ddb46c0000000000040604000000000008056c00000000000805bc000000000008056c00000000000805bc0a6aaaaaaaaaa4540e6a28b2eba68424000000000008056400000000000406040c36ddbb66ddb46c001030000000100000005000000000000000020594000000000008051400000000000406040000000000080514000000000004060400000000000c047404016b29085ac4d4003f5a637bd69404000000000002059400000000000805140', 3))
----
GEOMETRYCOLLECTION(POLYGON((-110 43.3333333333333,-110 70,100.5 70,59.3478260869565 32.826086956522,36.8181818181818 90,-110 43.3333333333333)),POLYGON((130 47.5,130 -45.7142857142858,36.8181818181818 90,59.3478260869565 32.826086956522,130 47.5)),POLYGON((130 -45.7142857142858,130 -90,-110 -90,-110 43.3333333333333,36.8181818181818 90,130 -45.7142857142858)),POLYGON((100.5 70,130 70,130 47.5,59.3478260869565 32.826086956522,100.5 70)))

query I 
SELECT ST_ASTEXT(ST_SIMPLIFY('{"type":"GeometryCollection","geometries":[{"type":"MultiPoint","coordinates":[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]]},{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}]}', 0.5))
----
GEOMETRYCOLLECTION(MULTIPOINT(-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 32,-117 33,-117 33,-117 33,-117 33,-117 33,-117 33,-117 33,-117 33,-117 33,-117 33,-117 33,-117 33,-117 32,-117 32,-117 32,-117 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-117 32,-117 32,-117 32,-117 32),MULTIPOLYGON(((-117 32,-117 33,-117 32,-116 32,-117 32))))

#test with NULL and empty value
query I
SELECT ST_SIMPLIFY('', 1)
----
(empty)

query I 
SELECT ST_SIMPLIFY(NULL, 2)
----
NULL

# test with invalid input
statement error
SELECT ST_SIMPLIFY(22, 1)

# test with table
statement ok
CREATE TABLE geographies (g Geography);

statement ok
INSERT INTO geographies VALUES('MULTIPOINT(0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9)'::GEOGRAPHY), ('01010000000000000000003E40BBB88D06F0762440'), ('POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))'::GEOGRAPHY), ('0101000000CB49287D21C451C0F0BF95ECD8A44540')

query R
SELECT ST_ASTEXT(ST_SIMPLIFY(g, 1)) FROM geographies
----
MULTIPOINT(0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9)
POINT(30 10.2323)
(empty)
POINT(-71.064544 43.28787)

statement ok
INSERT INTO geographies VALUES(''::GEOGRAPHY), (NULL::GEOGRAPHY), ('MULTIPOLYGON(((5 90,10 90,10 89,5 90)),((5 90,0 90,0 41,5 90)))')

query R
SELECT ST_ASTEXT(ST_SIMPLIFY(g, 1)) FROM geographies
----
MULTIPOINT(0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9)
POINT(30 10.2323)
(empty)
POINT(-71.064544 43.28787)
(empty)
NULL
MULTIPOLYGON(((5 90,0 90,0 41,5 90)))
