# name: test/sql/test_makeline.test
# description: ST_MAKELINE test
# group: [sql]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

# test basic 2D make line
query I
SELECT ST_MakeLine(ST_MakePoint(1,2), ST_MakePoint(3,4))
----
0102000020E610000002000000000000000000F03F000000000000004000000000000008400000000000001040

# test make line from array
query I
SELECT ST_MakeLine(ARRAY[ST_MakePoint(1,2), ST_MakePoint(3,4), ST_MakePoint(5,6)])
----
0102000020E610000003000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840

# test basic 3D make line
query I
SELECT ST_MakeLine(ST_MakePoint(1,2,3), ST_MakePoint(3,4,5))
----
01020000A0E610000002000000000000000000F03F00000000000000400000000000000840000000000000084000000000000010400000000000001440

# test with inputs are POINT and LINE
query I
SELECT ST_MAKELINE('POINT(5 6)', 'LINESTRING(5 1, 2 0)')
----
0102000020E610000003000000000000000000144000000000000018400000000000001440000000000000F03F00000000000000400000000000000000

# test with inputs are LINE and LINE
query I
SELECT ST_MAKELINE('LINESTRING(0 0, 0 0)', 'LINESTRING(5 1, 2 0)')
----
0102000020E61000000400000000000000000000000000000000000000000000000000000000000000000000000000000000001440000000000000F03F00000000000000400000000000000000

# test with inputs are array of POINT, LINE and MULTIPOINT
query I
SELECT ST_MAKELINE(ARRAY['POINT(5 6)'::GEOGRAPHY, 'LINESTRING(5 1, 2 0)'::GEOGRAPHY, 'MULTIPOINT(-70.9590 42.1180, -70.9611 42.1223)'::GEOGRAPHY])
----
0102000020E610000005000000000000000000144000000000000018400000000000001440000000000000F03F000000000000004000000000000000004C37894160BD51C0C976BE9F1A0F4540E10B93A982BD51C08126C286A70F4540

query I
SELECT ST_ASTEXT(ST_MakeLine(ARRAY[ST_MakePoint(-1.1, 1.1),ST_MakePoint(1.1, 1.1),ST_MakePoint(1.1, -1.1),ST_MakePoint(-1.1, -1.1),ST_MakePoint(-1.1, 1.1)]))
----
LINESTRING(-1.1 1.1,1.1 1.1,1.1 -1.1,-1.1 -1.1,-1.1 1.1)

# test invalid NOT POINT or LINE inputs
statement error
SELECT ST_MakeLine('POINT(5 6)', 'POLYGON((175 150, 20 40,50 60, 125 100, 175 150))')

# test invalid decodes
statement error
SELECT ST_MAKELINE('POINT(5 6)', 'a')

# test invalid parameters
statement error
SELECT ST_MAKELINE(5, 6)

# test make line with points table 
statement ok
CREATE TABLE tbl_points(p1 Geography, p2 Geography, p3 Geography)

statement ok
INSERT INTO tbl_points VALUES (ST_MAKEPOINT(42.123456, 10.54), ST_MAKEPOINT(-73.34343, 50.3432242), ST_MAKELINE(ST_MakePoint(1,2), ST_MakePoint(3,4))),(ST_MAKEPOINT(42, 0), ST_MAKEPOINT(73.34343, 13), 'MULTIPOINT(-70.9590 42.1180, -70.9611 42.1223)')

query R
SELECT ST_MAKELINE(p1, p2) from tbl_points
----
0102000020E6100000020000005B3FFD67CD0F454014AE47E17A142540C79DD2C1FA5552C00F1945C5EE2B4940
0102000020E61000000200000000000000000045400000000000000000C79DD2C1FA5552400000000000002A40

#test make point with null value 
#statement ok
#DELETE FROM tbl_points

statement ok
INSERT INTO tbl_points VALUES('POINT EMPTY', NULL, NULL), (ST_MAKEPOINT(-73.34343, 50.3432242), 'POINT(43 -12)', 'LINESTRING(5 1, 2 0)')

query R
SELECT ST_MAKELINE(p1, p2) from tbl_points
----
0102000020E6100000020000005B3FFD67CD0F454014AE47E17A142540C79DD2C1FA5552C00F1945C5EE2B4940
0102000020E61000000200000000000000000045400000000000000000C79DD2C1FA5552400000000000002A40
NULL
0102000020E610000002000000C79DD2C1FA5552C00F1945C5EE2B4940000000000080454000000000000028C0

query R
SELECT ST_ASTEXT(ST_MAKELINE(p1, p2)) from tbl_points
----
LINESTRING(42.123456 10.54,-73.34343 50.3432242)
LINESTRING(42 0,73.34343 13)
NULL
LINESTRING(-73.34343 50.3432242,43 -12)

query R
SELECT ST_MAKELINE([p1, p2, p3]) from tbl_points
----
0102000020E6100000040000005B3FFD67CD0F454014AE47E17A142540C79DD2C1FA5552C00F1945C5EE2B4940000000000000F03F000000000000004000000000000008400000000000001040
0102000020E61000000400000000000000000045400000000000000000C79DD2C1FA5552400000000000002A404C37894160BD51C0C976BE9F1A0F4540E10B93A982BD51C08126C286A70F4540
0102000020E610000000000000
0102000020E610000004000000C79DD2C1FA5552C00F1945C5EE2B4940000000000080454000000000000028C00000000000001440000000000000F03F00000000000000400000000000000000

query R
SELECT ST_ASTEXT(ST_MAKELINE([p1, p2, p3])) from tbl_points
----
LINESTRING(42.123456 10.54,-73.34343 50.3432242,1 2,3 4)
LINESTRING(42 0,73.34343 13,-70.959 42.118,-70.9611 42.1223)
LINESTRING EMPTY
LINESTRING(-73.34343 50.3432242,43 -12,5 1,2 0)

query R
SELECT ST_ASTEXT(ST_MAKELINE([p1, p2, p3, 'POINT(14 43)'::GEOGRAPHY])) from tbl_points
----
LINESTRING(42.123456 10.54,-73.34343 50.3432242,1 2,3 4,14 43)
LINESTRING(42 0,73.34343 13,-70.959 42.118,-70.9611 42.1223,14 43)
LINESTRING(14 43)
LINESTRING(-73.34343 50.3432242,43 -12,5 1,2 0,14 43)

query R
SELECT ST_ASTEXT(ST_MAKELINE([p1])) from tbl_points
----
LINESTRING(42.123456 10.54)
LINESTRING(42 0)
LINESTRING EMPTY
LINESTRING(-73.34343 50.3432242)
