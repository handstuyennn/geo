# name: test/sql/test_snaptogrid.test
# description: ST_SNAPTOGRID test
# group: [sql]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

#test with POINT
query I
SELECT ST_ASTEXT(ST_SNAPTOGRID('POINT(30 10.2323)', 0.01))
----
POINT(30 10.23)

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('010100000000000000000024400000000000004B40', 0.01))
----
POINT(10 54)

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('{"type":"Point","coordinates":[-71.064544,10.2323]}', 0.01))
----
POINT(-71.06 10.23)

#test with LINESTRING
query I
SELECT ST_ASTEXT(ST_SNAPTOGRID('LINESTRING(1.1115678 2.123, 4.111111 3.2374897, 4.11112 3.23748667)', 0.001))
----
LINESTRING(1.112 2.123,4.111 3.237)

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('010200000006000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d3653121454047ded1e65dcb51c0781c510ef83145404871a7835dcb51c0ebdaee75f53145406285c7c15ecb51c0ed88fc0df5314540', 10))
----
LINESTRING EMPTY

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('{"type":"LineString","coordinates":[[1,1],[2,2],[3,3],[4,4]]}', 2))
----
LINESTRING(0 0,2 2,4 4)

#test with POLYGON
query I
SELECT ST_ASTEXT(ST_SNAPTOGRID('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))', 0.001))
----
POLYGON((-71.172 42.354,-71.172 42.355000000000004,-71.171 42.355000000000004,-71.171 42.354,-71.172 42.354))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('010700000004000000010300000001000000060000000000000000805bc0a6aaaaaaaaaa45400000000000805bc00000000000805140000000000020594000000000008051404016b29085ac4d4003f5a637bd694040e6a28b2eba68424000000000008056400000000000805bc0a6aaaaaaaaaa45400103000000010000000500000000000000004060400000000000c047400000000000406040c36ddbb66ddb46c0e6a28b2eba68424000000000008056404016b29085ac4d4003f5a637bd69404000000000004060400000000000c04740010300000001000000060000000000000000406040c36ddbb66ddb46c0000000000040604000000000008056c00000000000805bc000000000008056c00000000000805bc0a6aaaaaaaaaa4540e6a28b2eba68424000000000008056400000000000406040c36ddbb66ddb46c001030000000100000005000000000000000020594000000000008051400000000000406040000000000080514000000000004060400000000000c047404016b29085ac4d4003f5a637bd69404000000000002059400000000000805140', 1))
----
GEOMETRYCOLLECTION(POLYGON((-110 43,-110 70,100 70,59 33,37 90,-110 43)),POLYGON((130 48,130 -46,37 90,59 33,130 48)),POLYGON((130 -46,130 -90,-110 -90,-110 43,37 90,130 -46)),POLYGON((100 70,130 70,130 48,59 33,100 70)))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('{"type":"Polygon","coordinates":[[[0,0],[0,15],[15,15],[15,0],[0,0]],[[2,2],[5,2],[5,5],[2,5],[2,2]]]}', 1))
----
POLYGON((0 0,0 15,15 15,15 0,0 0),(2 2,5 2,5 5,2 5,2 2))

#test with MULTIPOINT
query I
SELECT ST_ASTEXT(ST_SNAPTOGRID('MULTIPOINT(100 10 30, 100 74 30)', 50))
----
MULTIPOINT Z (100 0 30,100 50 30)

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('0104000000060000000101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f', 1))
----
MULTIPOINT(1 1,1 1,1 1,1 1,1 1,1 1)

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('{"type":"MultiPoint","coordinates":[[35,14]]}', 10))
----
MULTIPOINT(40 10)

#test with MULTILINESTRING
query I
SELECT ST_ASTEXT(ST_SNAPTOGRID('MULTILINESTRING((-118.584 38.374 20,-118.583 38.5 30),(-71.05957 42.3589 75, -71.061 43 90))', 0.01))
----
MULTILINESTRING Z ((-118.58 38.37 20,-118.58 38.5 30),(-71.06 42.36 75,-71.06 43 90))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('01050000C00200000001020000C004000000000000000000000000000000000000000000000000000000000000000000F03F00000000000000000000000000001440000000000000000000000000000000400000000000001440000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000104001020000C004000000000000000000F03F000000000000F03F0000000000000000000000000000F03F0000000000000840000000000000F03F0000000000000000000000000000F03F000000000000F03F00000000000008400000000000000000000000000000F03F000000000000F03F000000000000F03F0000000000000000000000000000F03F', 5))
----
MULTILINESTRING ZM ((0 0 0 1,0 5 0 2,5 0 0 3,0 0 0 4),(0 0 0 1,5 0 0 1,0 5 0 1,0 0 0 1))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('{"type":"MultiLineString","coordinates":[[[-89.734634999999997,31.492072000000000], [-89.734635999999997,31.492072000000000],[-89.734955999999997,31.492237999999997]]]}', 0.0001))
----
MULTILINESTRING((-89.7346 31.4921,-89.735 31.4922))

#test with MULTIPOLYGON
query I
SELECT ST_ASTEXT(ST_SNAPTOGRID('MULTIPOLYGON(((2.6 12.5,2.6 20.0,12.6 20.0,12.6 12.5,10.1 10.0,2.6 12.5),(5.1 15.0,10.1 15.0,7.6 17.5,5.1 15.0)),((15.1 10.0,15.1 20.0,17.6 17.5,15.1 10.0)))', 2))
----
MULTIPOLYGON(((2 12,2 20,12 20,12 12,10 10,2 12),(6 16,10 16,8 18,6 16)),((16 10,16 20,18 18,16 10)))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('0106000000030000000103000000020000000500000000000000000010400000000000000000000000000000000000000000000010C000000000000010C00000000000000000000000000000000000000000000010400000000000001040000000000000000005000000000000000000004000000000000000000000000000000000000000000000004000000000000000C00000000000000000000000000000000000000000000000C0000000000000004000000000000000000103000000020000000500000000000000000038400000000000000000000000000000344000000000000010C000000000000030400000000000000000000000000000344000000000000010400000000000003840000000000000000005000000000000000000364000000000000000000000000000003440000000000000004000000000000032400000000000000000000000000000344000000000000000C0000000000000364000000000000000000103000000020000000500000000000000000046400000000000000000000000000000444000000000000010C000000000000042400000000000000000000000000000444000000000000010400000000000004640000000000000000005000000000000000000454000000000000000000000000000004440000000000000004000000000000043400000000000000000000000000000444000000000000000C000000000000045400000000000000000', 5))
----
MULTIPOLYGON(((5 0,0 -5,-5 0,0 5,5 0)),((25 0,20 -5,15 0,20 5,25 0)),((45 0,40 -5,35 0,40 5,45 0)))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}', 1))
----
MULTIPOLYGON(((-117 32,-117 33,-117 32,-116 32,-117 32)))

#test with COLLECTION
query I
SELECT ST_ASTEXT(ST_SNAPTOGRID('GEOMETRYCOLLECTION(POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678)),LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932))', 0.001))
----
GEOMETRYCOLLECTION(LINESTRING(-71.16 42.259,-71.161 42.259))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('010700000004000000010300000001000000060000000000000000805bc0a6aaaaaaaaaa45400000000000805bc00000000000805140000000000020594000000000008051404016b29085ac4d4003f5a637bd694040e6a28b2eba68424000000000008056400000000000805bc0a6aaaaaaaaaa45400103000000010000000500000000000000004060400000000000c047400000000000406040c36ddbb66ddb46c0e6a28b2eba68424000000000008056404016b29085ac4d4003f5a637bd69404000000000004060400000000000c04740010300000001000000060000000000000000406040c36ddbb66ddb46c0000000000040604000000000008056c00000000000805bc000000000008056c00000000000805bc0a6aaaaaaaaaa4540e6a28b2eba68424000000000008056400000000000406040c36ddbb66ddb46c001030000000100000005000000000000000020594000000000008051400000000000406040000000000080514000000000004060400000000000c047404016b29085ac4d4003f5a637bd69404000000000002059400000000000805140', 100))
----
GEOMETRYCOLLECTION(POLYGON((-100 0,-100 100,100 100,100 0,0 100,-100 0)),POLYGON((100 0,100 -100,-100 -100,-100 0,0 100,100 0)))

query I 
SELECT ST_ASTEXT(ST_SNAPTOGRID('{"type":"GeometryCollection","geometries":[{"type":"MultiPoint","coordinates":[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]]},{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}]}', 2))
----
GEOMETRYCOLLECTION(MULTIPOINT(-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32,-116 32))

#test with NULL and empty value
query I
SELECT ST_SNAPTOGRID('', 1)
----
(empty)

query I 
SELECT ST_SNAPTOGRID(NULL, 1)
----
NULL

# test with invalid input
statement error
SELECT ST_SNAPTOGRID(22, 2)

# test with table
statement ok
CREATE TABLE geographies (g Geography);

statement ok
INSERT INTO geographies VALUES('MULTIPOINT(0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9)'::GEOGRAPHY), ('01010000000000000000003E40BBB88D06F0762440'), ('POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))'::GEOGRAPHY), ('0101000000CB49287D21C451C0F0BF95ECD8A44540')

query R
SELECT ST_ASTEXT(ST_SNAPTOGRID(g, 1)) FROM geographies
----
MULTIPOINT(1 1,1 1,1 1,1 1,1 1,1 1)
POINT(30 10)
POLYGON EMPTY
POINT(-71 43)

statement ok
INSERT INTO geographies VALUES(''::GEOGRAPHY), (NULL::GEOGRAPHY), ('MULTIPOLYGON(((5 90,10 90,10 89,5 90)),((5 90,0 90,0 41,5 90)))')

query R
SELECT ST_ASTEXT(ST_SNAPTOGRID(g, 1)) FROM geographies
----
MULTIPOINT(1 1,1 1,1 1,1 1,1 1,1 1)
POINT(30 10)
POLYGON EMPTY
POINT(-71 43)
(empty)
NULL
MULTIPOLYGON(((5 90,10 90,10 89,5 90)),((5 90,0 90,0 41,5 90)))
