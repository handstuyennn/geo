# name: test/sql/test_convexhull.test
# description: ST_CONVEXHULL test
# group: [sql]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

#test with POINT
query I
SELECT ST_ASTEXT(ST_CONVEXHULL('POINT(30 10.2323)'))
----
POINT(30 10.2323)

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('010100000000000000000024400000000000004B40'))
----
POINT(10 54)

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('{"type":"Point","coordinates":[-71.064544,10.2323]}'))
----
POINT(-71.064544 10.2323)

#test with LINESTRING
query I
SELECT ST_ASTEXT(ST_CONVEXHULL('SRID=4326;LINESTRING(-72.1260 42.45, -72.1240 42.45666, -72.123 42.1546)'))
----
POLYGON((-72.123 42.1546,-72.126 42.45,-72.124 42.45666,-72.123 42.1546))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('010200000003000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d36531214540'))
----
POLYGON((-71.160281 42.258729,-71.161144 42.25932,-71.160837 42.259113,-71.160281 42.258729))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('{"type":"LineString","coordinates":[[1,1],[2,2],[3,3],[4,4]]}'))
----
LINESTRING(1 1,4 4)

#test with POLYGON
query I
SELECT ST_ASTEXT(ST_CONVEXHULL('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))'))
----
POLYGON((-71.17166 42.353675,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17166 42.353675))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('010300000001000000050000006285c7c15ecb51c0ed88fc0df531454028a46f245fcb51c009075ea6f731454047ded1e65dcb51c0781c510ef83145404871a7835dcb51c0ebdaee75f53145406285c7c15ecb51c0ed88fc0df5314540'))
----
POLYGON((-71.1776585052917 42.3902909739571,-71.1776820268866 42.3903701743239,-71.1776063012595 42.3903825660754,-71.1775826583081 42.3903033653531,-71.1776585052917 42.3902909739571))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('{"type":"Polygon","coordinates":[[[0,0],[0,50],[150,50],[150,0],[0,0]],[[20,20],[50,20],[50,50],[20,50],[20,20]]]}'))
----
POLYGON((0 0,0 50,150 50,150 0,0 0))

#test with MULTIPOINT
query I
SELECT ST_ASTEXT(ST_CONVEXHULL('MULTIPOINT(100 90 30, 50 74 1000)'))
----
LINESTRING Z (100 90 30,50 74 1000)

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('0104000000060000000101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f'))
----
POINT(0.9 0.9)

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('{"type":"MultiPoint","coordinates":[[35,14]]}'))
----
POINT(35 14)

#test with MULTILINESTRING
query I
SELECT ST_ASTEXT(ST_CONVEXHULL('MULTILINESTRING((-118.584 38.374 20,-118.583 38.5 30),(-71.05957 42.3589 75, -71.061 43 90))'))
----
POLYGON Z ((-118.584 38.374 20,-118.583 38.5 30,-71.061 43 90,-71.05957 42.3589 75,-118.584 38.374 20))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('01050000C00200000001020000C004000000000000000000000000000000000000000000000000000000000000000000F03F00000000000000000000000000001440000000000000000000000000000000400000000000001440000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000104001020000C004000000000000000000F03F000000000000F03F0000000000000000000000000000F03F0000000000000840000000000000F03F0000000000000000000000000000F03F000000000000F03F00000000000008400000000000000000000000000000F03F000000000000F03F000000000000F03F0000000000000000000000000000F03F'))
----
POLYGON Z ((0 0 0,0 5 0,5 0 0,0 0 0))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('{"type":"MultiLineString","coordinates":[[[-89.734634999999997,31.492072000000000],[-89.734955999999997,31.492237999999997]]]}'))
----
LINESTRING(-89.734635 31.492072,-89.734956 31.492237999999997)

#test with MULTIPOLYGON
query I
SELECT ST_ASTEXT(ST_CONVEXHULL('MULTIPOLYGON(((-71.1031880899493 42.3152774590236,-71.1031627617667 42.3152960829043,-71.102923838298 42.3149156848307,-71.1023097974109 42.3151969047397,-71.1019285062273 42.3147384934248,-71.102505233663 42.3144722937587,-71.10277487471 42.3141658254797,-71.103113945163 42.3142739188902,-71.10324876416 42.31402489987,-71.1033002961013 42.3140393340215,-71.1033488797549 42.3139495090772,-71.103396240451 42.3138632439557,-71.1041521907712 42.3141153348029,-71.1041411411543 42.3141545014533,-71.1041287795912 42.3142114839058,-71.1041188134329 42.3142693656241,-71.1041112482575 42.3143272556118,-71.1041072845732 42.3143851580048,-71.1041057218871 42.3144430686681,-71.1041065602059 42.3145009876017,-71.1041097995362 42.3145589148055,-71.1041166403905 42.3146168544148,-71.1041258822717 42.3146748022936,-71.1041375307579 42.3147318674446,-71.1041492906949 42.3147711126569,-71.1041598612795 42.314808571739,-71.1042515013869 42.3151287620809,-71.1041173835118 42.3150739481917,-71.1040809891419 42.3151344119048,-71.1040438678912 42.3151191367447,-71.1040194562988 42.3151832057859,-71.1038734225584 42.3151140942995,-71.1038446938243 42.3151006300338,-71.1038315271889 42.315094347535,-71.1037393329282 42.315054824985,-71.1035447555574 42.3152608696313,-71.1033436658644 42.3151648370544,-71.1032580383161 42.3152269126061,-71.103223066939 42.3152517403219,-71.1031880899493 42.3152774590236)),((-71.1043632495873 42.315113108546,-71.1043583974082 42.3151211109857,-71.1043443253471 42.3150676015829,-71.1043850704575 42.3150793250568,-71.1043632495873 42.315113108546)))'))
----
POLYGON((-71.103396240451 42.3138632439557,-71.1041521907712 42.3141153348029,-71.1043850704575 42.3150793250568,-71.1043583974082 42.3151211109857,-71.1040194562988 42.3151832057859,-71.1035447555574 42.3152608696313,-71.1031627617667 42.3152960829043,-71.1023097974109 42.3151969047397,-71.1019285062273 42.3147384934248,-71.10277487471 42.3141658254797,-71.103396240451 42.3138632439557))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('0106000000030000000103000000020000000500000000000000000010400000000000000000000000000000000000000000000010C000000000000010C00000000000000000000000000000000000000000000010400000000000001040000000000000000005000000000000000000004000000000000000000000000000000000000000000000004000000000000000C00000000000000000000000000000000000000000000000C0000000000000004000000000000000000103000000020000000500000000000000000038400000000000000000000000000000344000000000000010C000000000000030400000000000000000000000000000344000000000000010400000000000003840000000000000000005000000000000000000364000000000000000000000000000003440000000000000004000000000000032400000000000000000000000000000344000000000000000C0000000000000364000000000000000000103000000020000000500000000000000000046400000000000000000000000000000444000000000000010C000000000000042400000000000000000000000000000444000000000000010400000000000004640000000000000000005000000000000000000454000000000000000000000000000004440000000000000004000000000000043400000000000000000000000000000444000000000000000C000000000000045400000000000000000'))
----
POLYGON((0 -4,-4 0,0 4,40 4,44 0,40 -4,0 -4))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}'))
----
POLYGON((-117 32,-117 33,-116 32,-117 32))

#test with COLLECTION
query I
SELECT ST_ASTEXT(ST_CONVEXHULL('GEOMETRYCOLLECTION(POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678)),LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932))'))
----
POLYGON((-71.160281 42.258729,-71.161144 42.25932,-71.04096 42.285752,-71.040878 42.285678,-71.040943 42.2856,-71.160281 42.258729))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('010700000002000000010300000001000000070000000282397afcca51c0d734ef38452d4540f303577902cb51c02aac5450512d4540130a117008cb51c0b9895a9a5b2d45408ae942acfeca51c0a30392b06f2d4540ee26f8a6e9ca51c03ae97de36b2d454042ec4ca1f3ca51c00f80b8ab572d45400282397afcca51c0d734ef38452d4540010200000003000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d36531214540'))
----
POLYGON((-71.160281 42.258729,-71.161144 42.25932,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.160281 42.258729))

query I 
SELECT ST_ASTEXT(ST_CONVEXHULL('{"type":"GeometryCollection","geometries":[{"type":"MultiPoint","coordinates":[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]]},{"type":"MultiLineString","coordinates":[[[-89.734634999999997,31.492072000000000],[-89.734955999999997,31.492237999999997]]]},{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}]}'))
----
POLYGON((-89.734635 31.492072,-117 32,-117 33,-89.734956 31.492237999999997,-89.734635 31.492072))

#test with NULL and empty value
query I
SELECT ST_CONVEXHULL('')
----
(empty)

query I 
SELECT ST_CONVEXHULL(NULL)
----
NULL

# test with invalid input
statement error
SELECT ST_CONVEXHULL(22)

# test with table
statement ok
CREATE TABLE geographies (g Geography);

statement ok
INSERT INTO geographies VALUES('MULTIPOINT(0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9)'::GEOGRAPHY), ('01010000000000000000003E40BBB88D06F0762440'), ('POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))'::GEOGRAPHY), ('0101000000CB49287D21C451C0F0BF95ECD8A44540')

query R
SELECT ST_ASTEXT(ST_CONVEXHULL(g)) FROM geographies
----
POINT(0.9 0.9)
POINT(30 10.2323)
POLYGON((-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678,-71.040943 42.2856))
POINT(-71.064544 43.28787)

statement ok
INSERT INTO geographies VALUES(''::GEOGRAPHY), (NULL::GEOGRAPHY), ('MULTIPOLYGON(((5 90,10 90,10 81,5 90)),((5 90,0 90,0 41,5 90)))')

query R
SELECT ST_ASTEXT(ST_CONVEXHULL(g)) FROM geographies
----
POINT(0.9 0.9)
POINT(30 10.2323)
POLYGON((-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678,-71.040943 42.2856))
POINT(-71.064544 43.28787)
(empty)
NULL
POLYGON((0 41,0 90,10 90,10 81,0 41))
