# name: test/sql/test_pointn.test
# description: ST_POINTN test
# group: [sql]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

#test with POINT
query I
SELECT ST_ASTEXT(ST_POINTN('POINT(30 10.2323)', 1))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('010100000000000000000024400000000000004B40', 2))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('{"type":"Point","coordinates":[-71.064544,10.2323]}', 3))
----
NULL

#test with LINESTRING
query I
SELECT ST_ASTEXT(ST_POINTN('LINESTRING(0 0, 0 10, 0 51, 50 20, 30 20, 7 32)', 2))
----
POINT(0 10)

query I 
SELECT ST_ASTEXT(ST_POINTN('010200000006000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d3653121454047ded1e65dcb51c0781c510ef83145404871a7835dcb51c0ebdaee75f53145406285c7c15ecb51c0ed88fc0df5314540', 4))
----
POINT(-71.1776063012595 42.3903825660754)

query I 
SELECT ST_ASTEXT(ST_POINTN('{"type":"LineString","coordinates":[[1,1],[2,2],[2,3],[4,4]]}', 2))
----
POINT(2 2)

#test with POLYGON
query I
SELECT ST_ASTEXT(ST_POINTN('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))', 2))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('010300000001000000050000004a5349305fcb51c01c21e402f53145406ba94a2e5fcb51c048dc8411f8314540775e168b5dcb51c0988b2b0ff83145406a0561835dcb51c0bde47c00f53145404a5349305fcb51c01c21e402f5314540', 3))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('{"type":"Polygon","coordinates":[[[0,0],[0,50],[150,50],[150,0],[0,0]],[[20,20],[50,20],[50,50],[20,50],[20,20]]]}', 5))
----
NULL

#test with MULTIPOINT
query I
SELECT ST_ASTEXT(ST_POINTN('MULTIPOINT(0 0 3 2, 0 10 6 1, 0 51 1 6, 50 20 6 7, 30 20 9 9, 7 32 10 5)', 20))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('0104000000060000000101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f', 1))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('{"type":"MultiPoint","coordinates":[[35,14]]}', 1))
----
NULL

#test with MULTILINESTRING
query I
SELECT ST_ASTEXT(ST_POINTN('MULTILINESTRING((0 0 3 2, 0 10 6 1, 0 51 1 6, 50 20 6 7, 30 20 9 9, 7 32 10 5), (0 0 4 3, 1 1 2 3, 20 20 5 30))', 5))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('01050000C00200000001020000C004000000000000000000000000000000000000000000000000000000000000000000F03F00000000000000000000000000001440000000000000000000000000000000400000000000001440000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000104001020000C004000000000000000000F03F000000000000F03F0000000000000000000000000000F03F0000000000000840000000000000F03F0000000000000000000000000000F03F000000000000F03F00000000000008400000000000000000000000000000F03F000000000000F03F000000000000F03F0000000000000000000000000000F03F', 2))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('{"type":"MultiLineString","coordinates":[[[-89.734634999999997,31.492072000000000],[-89.734955999999997,31.492237999999997]]]}', 2))
----
NULL

#test with MULTIPOLYGON
query I
SELECT ST_ASTEXT(ST_POINTN('MULTIPOLYGON(((100 90, 100 30, 130 30, 130 90, 100 90)), ((0 0, 10 0, 10 10, 0 10, 0 0),(5 5, 5 6, 6 6, 8 5, 5 5)) )', 10))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('0106000000030000000103000000020000000500000000000000000010400000000000000000000000000000000000000000000010C000000000000010C00000000000000000000000000000000000000000000010400000000000001040000000000000000005000000000000000000004000000000000000000000000000000000000000000000004000000000000000C00000000000000000000000000000000000000000000000C0000000000000004000000000000000000103000000020000000500000000000000000038400000000000000000000000000000344000000000000010C000000000000030400000000000000000000000000000344000000000000010400000000000003840000000000000000005000000000000000000364000000000000000000000000000003440000000000000004000000000000032400000000000000000000000000000344000000000000000C0000000000000364000000000000000000103000000020000000500000000000000000046400000000000000000000000000000444000000000000010C000000000000042400000000000000000000000000000444000000000000010400000000000004640000000000000000005000000000000000000454000000000000000000000000000004440000000000000004000000000000043400000000000000000000000000000444000000000000000C000000000000045400000000000000000', 2))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}', 2))
----
NULL

#test with COLLECTION
query I
SELECT ST_ASTEXT(ST_POINTN('GEOMETRYCOLLECTION(POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678)),LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932))', 1))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('010700000003000000010300000001000000070000000282397afcca51c0d734ef38452d4540f303577902cb51c02aac5450512d4540130a117008cb51c0b9895a9a5b2d45408ae942acfeca51c0a30392b06f2d4540ee26f8a6e9ca51c03ae97de36b2d454042ec4ca1f3ca51c00f80b8ab572d45400282397afcca51c0d734ef38452d4540010200000003000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d3653121454001060000000100000001030000000100000039000000b4c876be9fba51c09487855ad30c454094f6065f98bc51c0ce1951da1b0c4540d122dbf97ebe51c0091b9e5e290b45402d211ff46cbe51c033333333330b4540b537f8c264be51c0c1a8a44e400b4540cac342ad69be51c088635ddc460b45402d211ff46cbe51c06c09f9a0670b4540f5dbd78173be51c096218e75710b4540a60a462575be51c0c139234a7b0b4540a60a462575be51c088f4dbd7810b45402d211ff46cbe51c0b30c71ac8b0b4540917efb3a70be51c04182e2c7980b45407cf2b0506bbe51c0a4dfbe0e9c0b45407cf2b0506bbe51c088855ad3bc0b454043ad69de71be51c0401361c3d30b4540df4f8d976ebe51c0ce88d2dee00b4540df4f8d976ebe51c040a4dfbe0e0c45401895d40968be51c095d40968220c4540df4f8d976ebe51c087a757ca320c45401895d40968be51c0787aa52c430c45401895d40968be51c007f01648500c4540a60a462575be51c031992a18950c45403480b74082be51c0bf0e9c33a20c4540e6ae25e483be51c04d840d4faf0c4540fb3a70ce88be51c0a2b437f8c20c4540fb3a70ce88be51c0f7e461a1d60c4540e6ae25e483be51c0be9f1a2fdd0c45404a0c022b87be51c014d044d8f00c45408351499d80be51c030bb270f0b0d4540e6ae25e483be51c0e9482eff210d454098dd938785be51c0a1d634ef380d4540c3f5285c8fbe51c0211ff46c560d45405f984c158cbe51c0857cd0b3590d4540742497ff90be51c0857cd0b3590d4540d881734694be51c0764f1e166a0d45405f984c158cbe51c05af5b9da8a0d454011c7bab88dbe51c0840d4faf940d45408ab0e1e995be51c01283c0caa10d45409f3c2cd49abe51c02041f163cc0d4540ca54c1a8a4be51c0d9cef753e30d4540bb270f0bb5be51c0a089b0e1e90d4540499d8026c2be51c0cba145b6f30d4540fbcbeec9c3be51c0f5b9da8afd0d4540499d8026c2be51c04bea0434110e45405f29cb10c7be51c02e90a0f8310e4540adfa5c6dc5be51c058a835cd3b0e4540bb270f0bb5be51c0e71da7e8480e4540910f7a36abbe51c02d211ff46c0e45402db29defa7be51c0f5dbd781730e454018265305a3be51c0e6ae25e4830e45402db29defa7be51c0d8817346940e4540dfe00b93a9be51c09f3c2cd49a0e4540f9a067b3eabf51c0e71da7e8480e45404703780b24c051c0f163cc5d4b104540ea04341136bc51c041f163cc5d134540560e2db29dbb51c0f4fdd478e90e4540b4c876be9fba51c09487855ad30c4540', 3))
----
NULL

query I 
SELECT ST_ASTEXT(ST_POINTN('{"type":"GeometryCollection","geometries":[{"type":"MultiPoint","coordinates":[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]]},{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}]}', 15))
----
NULL

#test with NULL and empty value
query I
SELECT ST_POINTN('', 1)
----
(empty)

query I 
SELECT ST_POINTN(NULL, 2)
----
NULL

# test with invalid input
statement error
SELECT ST_POINTN(22, 1)

# test with table
statement ok
CREATE TABLE geographies (g Geography);

statement ok
INSERT INTO geographies VALUES('LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932)'::GEOGRAPHY), ('01010000000000000000003E40BBB88D06F0762440'), ('POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))'::GEOGRAPHY), ('0101000000CB49287D21C451C0F0BF95ECD8A44540')

query R
SELECT ST_ASTEXT(ST_POINTN(g, 3)) FROM geographies
----
POINT(-71.161144 42.25932)
NULL
NULL
NULL

statement ok
INSERT INTO geographies VALUES(''::GEOGRAPHY), (NULL::GEOGRAPHY), ('010200000003000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d36531214540')

query R
SELECT ST_ASTEXT(ST_POINTN(g, 3)) FROM geographies
----
POINT(-71.161144 42.25932)
NULL
NULL
NULL
(empty)
NULL
POINT(-71.161144 42.25932)
