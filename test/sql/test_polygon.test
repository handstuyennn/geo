# name: test/sql/test_polygon.test
# description: POLYGON tests
# group: [sql]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE geographies (g Geography);

# Insert valid geometry strings
statement ok
INSERT INTO geographies VALUES('010300000001000000070000000282397afcca51c0d734ef38452d4540f303577902cb51c02aac5450512d4540130a117008cb51c0b9895a9a5b2d45408ae942acfeca51c0a30392b06f2d4540ee26f8a6e9ca51c03ae97de36b2d454042ec4ca1f3ca51c00f80b8ab572d45400282397afcca51c0d734ef38452d4540'), ('010200000004000000CB49287D21C451C0000000000000084000000000000012405917B7D1009E1640F0BF95ECD8A4454000000000000014400000000000001C40D8F0F44A59662040'), ('01030000800100000005000000000000000000000000000000000000000000000000000000000000000000000000000000000014400000000000000000000000000000144000000000000014400000000000000000000000000000144000000000000000000000000000000000000000000000000000000000000000000000000000000000')

query T
SELECT * FROM geographies
----
0103000020E610000001000000070000000282397AFCCA51C0D734EF38452D4540F303577902CB51C02AAC5450512D4540130A117008CB51C0B9895A9A5B2D45408AE942ACFECA51C0A30392B06F2D4540EE26F8A6E9CA51C03AE97DE36B2D454042EC4CA1F3CA51C00F80B8AB572D45400282397AFCCA51C0D734EF38452D4540
0102000020E610000004000000CB49287D21C451C0000000000000084000000000000012405917B7D1009E1640F0BF95ECD8A4454000000000000014400000000000001C40D8F0F44A59662040
01030000A0E61000000100000005000000000000000000000000000000000000000000000000000000000000000000000000000000000014400000000000000000000000000000144000000000000014400000000000000000000000000000144000000000000000000000000000000000000000000000000000000000000000000000000000000000

query T
SELECT ST_ASTEXT(g) FROM geographies
----
POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))
LINESTRING(-71.064544 3,4.5 5.6543,43.28787 5,7 8.1999)
POLYGON Z ((0 0 0,0 5 0,5 5 0,5 0 0,0 0 0))

statement error
INSERT INTO geographies(('0103000000010000000B00000033333333C7A80C4166666666D7732B410000000084AC0C416666666601732B410000000010AD0C41CDCCCCCCD8722B41CDCCCCCC14AE0C41CDCCCCCC39722B4100000000C4AB0C416666666601722B410000000058AC0C41CDCCCCCCAA712B410000000084AF0C410000000092702B41CDCCCCCC54AC0C4100000000FA6F2B419A99999919A80C41CDCCCCCC6E712B419A999999A5A30C41CDCCCCCC66722B4133333333C7A80C4166666666D7732B414'))

# Insert valid strings with text
statement ok
DELETE FROM geographies

statement ok
INSERT INTO geographies VALUES('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855, -71.17112 42.354238,-71.17166 42.353675))'), ('POLYGON((0 0 0,0 5 0,5 5 0,5 0 0,0 0 0))'), ('POLYGON((-71.1776848522251 42.3902896512902,-71.1776843766326 42.3903829478009,-71.1775844305465 42.3903826677917,-71.1775825927231 42.3902893647987,-71.1776848522251 42.3902896512902))')

query T
SELECT * FROM geographies
----
0103000020E610000001000000070000000282397AFCCA51C0D734EF38452D4540F303577902CB51C02AAC5450512D4540130A117008CB51C0B9895A9A5B2D45408AE942ACFECA51C0A30392B06F2D4540EE26F8A6E9CA51C03AE97DE36B2D454042EC4CA1F3CA51C00F80B8AB572D45400282397AFCCA51C0D734EF38452D4540
01030000A0E61000000100000005000000000000000000000000000000000000000000000000000000000000000000000000000000000014400000000000000000000000000000144000000000000014400000000000000000000000000000144000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103000020E610000001000000050000004A5349305FCB51C01C21E402F53145406BA94A2E5FCB51C048DC8411F8314540775E168B5DCB51C0988B2B0FF83145406A0561835DCB51C0BDE47C00F53145404A5349305FCB51C01C21E402F5314540

query T
SELECT ST_ASTEXT(g) FROM geographies
----
POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))
POLYGON Z ((0 0 0,0 5 0,5 5 0,5 0 0,0 0 0))
POLYGON((-71.1776848522251 42.3902896512902,-71.1776843766326 42.3903829478009,-71.1775844305465 42.3903826677917,-71.1775825927231 42.3902893647987,-71.1776848522251 42.3902896512902))

statement error
INSERT INTO geographies(('POLYGON(-71.064544 42.28787)'))

# Insert valid strings with geojson
statement ok
DELETE FROM geographies

statement ok
INSERT INTO geographies VALUES('{"type":"Polygon","coordinates":[[[42,42],[45,45],[45,42],[42,42]]]}'), ('{"type":"Polygon","coordinates":[[[0,0],[1,1],[0,1],[0,0]]]}'), ('{"type":"Polygon","coordinates":[[[42,42.23],[45,45.56],[45,42],[42,42.11]]]}')

query T
SELECT * FROM geographies
----
0103000020E6100000010000000400000000000000000045400000000000004540000000000080464000000000008046400000000000804640000000000000454000000000000045400000000000004540
0103000020E6100000010000000400000000000000000000000000000000000000000000000000F03F000000000000F03F0000000000000000000000000000F03F00000000000000000000000000000000
0103000020E6100000010000000400000000000000000045403D0AD7A3701D4540000000000080464048E17A14AEC74640000000000080464000000000000045400000000000004540AE47E17A140E4540

query T
SELECT ST_ASTEXT(g) FROM geographies
----
POLYGON((42 42,45 45,45 42,42 42))
POLYGON((0 0,1 1,0 1,0 0))
POLYGON((42 42.23,45 45.56,45 42,42 42.11))

# Insert invalid geojson string
statement error
INSERT INTO geographies(('{"type":"Polygon","coordinates":[30,10.2323]}'))
