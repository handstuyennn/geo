# name: test/sql/test_boundingbox.test
# description: ST_BOUNDINGBOX/ST_ENVELOPE test
# group: [sql]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

#test with POINT
query I
SELECT ST_ASTEXT(ST_BOUNDINGBOX('POINT(30 10.2323)'))
----
POINT(30 10.2323)

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('010100000000000000000024400000000000004B40'))
----
POINT(10 54)

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('{"type":"Point","coordinates":[-71.064544,10.2323]}'))
----
POINT(-71.064544 10.2323)

#test with LINESTRING
query I
SELECT ST_ASTEXT(ST_BOUNDINGBOX('SRID=4326;LINESTRING(-72.1260 42.45, -72.1240 42.45666, -72.123 42.1546)'))
----
POLYGON((-72.126 42.1546,-72.126 42.45666,-72.123 42.45666,-72.123 42.1546,-72.126 42.1546))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('010200000003000000e44a3d0b42ca51c06ec328081e21454027bf45274bca51c0f67b629d2a214540957cec2e50ca51c07099d36531214540'))
----
POLYGON((-71.161144 42.258729,-71.161144 42.25932,-71.160281 42.25932,-71.160281 42.258729,-71.161144 42.258729))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('{"type":"LineString","coordinates":[[1,1],[2,2],[3,3],[4,4]]}'))
----
POLYGON((1 1,1 4,4 4,4 1,1 1))

#test with POLYGON
query I
SELECT ST_ASTEXT(ST_BOUNDINGBOX('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))'))
----
POLYGON((-71.17239 42.353675,-71.17239 42.354971,-71.170511 42.354971,-71.170511 42.353675,-71.17239 42.353675))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('010300000001000000050000004a5349305fcb51c01c21e402f53145406ba94a2e5fcb51c048dc8411f8314540775e168b5dcb51c0988b2b0ff83145406a0561835dcb51c0bde47c00f53145404a5349305fcb51c01c21e402f5314540'))
----
POLYGON((-71.1776848522251 42.3902893647987,-71.1776848522251 42.3903829478009,-71.1775825927231 42.3903829478009,-71.1775825927231 42.3902893647987,-71.1776848522251 42.3902893647987))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('{"type":"Polygon","coordinates":[[[0,0],[0,50],[150,50],[150,0],[0,0]],[[20,20],[50,20],[50,50],[20,50],[20,20]]]}'))
----
POLYGON((0 0,0 50,150 50,150 0,0 0))

#test with MULTIPOINT
query I
SELECT ST_ASTEXT(ST_BOUNDINGBOX('MULTIPOINT(100 90, 50 74)'))
----
POLYGON((50 74,50 90,100 90,100 74,50 74))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('0104000000060000000101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f0101000000cdccccccccccec3fcdccccccccccec3f'))
----
POINT(0.9 0.9)

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('{"type":"MultiPoint","coordinates":[[35,14]]}'))
----
POINT(35 14)

#test with MULTILINESTRING
query I
SELECT ST_ASTEXT(ST_BOUNDINGBOX('MULTILINESTRING((-118.584 38.374,-118.583 38.5),(-71.05957 42.3589, -71.061 43))'))
----
POLYGON((-118.584 38.374,-118.584 43,-71.05957 43,-71.05957 38.374,-118.584 38.374))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('01050000000300000001020000000200000000000000000053400000000000002e400000000000805640000000000000264001020000000200000000000000008056400000000000002640000000000040594000000000000024400102000000020000000000000000805f400000000000002e400000000000805f400000000000403040'))
----
POLYGON((76 10,76 16.25,126 16.25,126 10,76 10))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('{"type":"MultiLineString","coordinates":[[[-89.734634999999997,31.492072000000000],[-89.734955999999997,31.492237999999997]]]}'))
----
POLYGON((-89.734956 31.492072,-89.734956 31.492237999999997,-89.734635 31.492237999999997,-89.734635 31.492072,-89.734956 31.492072))

#test with MULTIPOLYGON
query I
SELECT ST_ASTEXT(ST_BOUNDINGBOX('MULTIPOLYGON(((26 15,26 20,126 20,126 15,101 10,26 15),(51 10,101 10,76 15,51 10)),((151 10,151 20,176 15,151 10)))'))
----
POLYGON((26 10,26 20,176 20,176 10,26 10))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('0106000000030000000103000000020000000500000000000000000010400000000000000000000000000000000000000000000010C000000000000010C00000000000000000000000000000000000000000000010400000000000001040000000000000000005000000000000000000004000000000000000000000000000000000000000000000004000000000000000C00000000000000000000000000000000000000000000000C0000000000000004000000000000000000103000000020000000500000000000000000038400000000000000000000000000000344000000000000010C000000000000030400000000000000000000000000000344000000000000010400000000000003840000000000000000005000000000000000000364000000000000000000000000000003440000000000000004000000000000032400000000000000000000000000000344000000000000000C0000000000000364000000000000000000103000000020000000500000000000000000046400000000000000000000000000000444000000000000010C000000000000042400000000000000000000000000000444000000000000010400000000000004640000000000000000005000000000000000000454000000000000000000000000000004440000000000000004000000000000043400000000000000000000000000000444000000000000000C000000000000045400000000000000000'))
----
POLYGON((-4 -4,-4 4,44 4,44 -4,-4 -4))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}'))
----
POLYGON((-117 32,-117 33,-116 33,-116 32,-117 32))

#test with COLLECTION
query I
SELECT ST_ASTEXT(ST_BOUNDINGBOX('GEOMETRYCOLLECTION(POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678)),LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932))'))
----
POLYGON((-71.161144 42.258729,-71.161144 42.285752,-71.040878 42.285752,-71.040878 42.258729,-71.161144 42.258729))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('010700000004000000010300000001000000060000000000000000805bc0a6aaaaaaaaaa45400000000000805bc00000000000805140000000000020594000000000008051404016b29085ac4d4003f5a637bd694040e6a28b2eba68424000000000008056400000000000805bc0a6aaaaaaaaaa45400103000000010000000500000000000000004060400000000000c047400000000000406040c36ddbb66ddb46c0e6a28b2eba68424000000000008056404016b29085ac4d4003f5a637bd69404000000000004060400000000000c04740010300000001000000060000000000000000406040c36ddbb66ddb46c0000000000040604000000000008056c00000000000805bc000000000008056c00000000000805bc0a6aaaaaaaaaa4540e6a28b2eba68424000000000008056400000000000406040c36ddbb66ddb46c001030000000100000005000000000000000020594000000000008051400000000000406040000000000080514000000000004060400000000000c047404016b29085ac4d4003f5a637bd69404000000000002059400000000000805140'))
----
POLYGON((-110 -90,-110 90,130 90,130 -90,-110 -90))

query I 
SELECT ST_ASTEXT(ST_BOUNDINGBOX('{"type":"GeometryCollection","geometries":[{"type":"MultiPoint","coordinates":[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]]},{"type":"MultiLineString","coordinates":[[[-89.734634999999997,31.492072000000000],[-89.734955999999997,31.492237999999997]]]},{"type":"MultiPolygon","coordinates":[[[[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,32],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,32],[-117,32],[-117,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-116,32],[-117,32],[-117,32],[-117,32],[-117,32]],[[-117,33],[-117,33],[-117,33],[-117,33],[-117,33],[-117,32],[-117,33]]]]}]}'))
----
POLYGON((-117 31.492072,-117 33,-89.734635 33,-89.734635 31.492072,-117 31.492072))

#test with NULL and empty value
query I
SELECT ST_BOUNDINGBOX('')
----
(empty)

query I 
SELECT ST_BOUNDINGBOX(NULL)
----
NULL

# test with invalid input
statement error
SELECT ST_BOUNDINGBOX(22)

# test with table
statement ok
CREATE TABLE geographies (g Geography);

statement ok
INSERT INTO geographies VALUES('MULTIPOINT(0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9,0.9 0.9)'::GEOGRAPHY), ('01010000000000000000003E40BBB88D06F0762440'), ('POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))'::GEOGRAPHY), ('0101000000CB49287D21C451C0F0BF95ECD8A44540')

query R
SELECT ST_ASTEXT(ST_BOUNDINGBOX(g)) FROM geographies
----
POINT(0.9 0.9)
POINT(30 10.2323)
POLYGON((-71.04096 42.2856,-71.04096 42.285752,-71.040878 42.285752,-71.040878 42.2856,-71.04096 42.2856))
POINT(-71.064544 43.28787)

statement ok
INSERT INTO geographies VALUES(''::GEOGRAPHY), (NULL::GEOGRAPHY), ('MULTIPOLYGON(((5 90,10 90,10 89,5 90)),((5 90,0 90,0 41,5 90)))')

query R
SELECT ST_ASTEXT(ST_BOUNDINGBOX(g)) FROM geographies
----
POINT(0.9 0.9)
POINT(30 10.2323)
POLYGON((-71.04096 42.2856,-71.04096 42.285752,-71.040878 42.285752,-71.040878 42.2856,-71.04096 42.2856))
POINT(-71.064544 43.28787)
(empty)
NULL
POLYGON((0 41,0 90,10 90,10 41,0 41))
